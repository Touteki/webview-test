<!DOCTYPE html>
<html lang="ru">
<body style="font-size:20px; padding:20px;">

  <button id="startBtn"
    style="
      width:100%;
      padding:20px;
      font-size:24px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#f0f0f0;
    ">
    Начать сканирование
  </button>

  <video id="video"
    autoplay
    playsinline
    style="width:100%; display:none; margin-top:20px; border-radius:12px;">
  </video>

  <canvas id="canvas" style="display:none;"></canvas>

  <div id="result" style="margin-top:20px; font-size:24px;"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const startBtn = document.getElementById('startBtn');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const result = document.getElementById('result');

let scanning = false;

startBtn.onclick = async () => {
  result.textContent = "";
  scanning = true;

  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
  } catch(e) {
    result.textContent = "Нет доступа к камере";
    return;
  }

  video.srcObject = stream;
  video.style.display = 'block';

  requestAnimationFrame(scan);
};

function scan() {
  if (!scanning) return;

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);

    const code = jsQR(img.data, canvas.width, canvas.height);

    if (code) {
      scanning = false;

      result.textContent = "QR: " + code.data;

      const stream = video.srcObject;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
      }

      video.style.display = 'none';
      return;
    }
  }

  requestAnimationFrame(scan);
}
</script>
</body>
</html>
