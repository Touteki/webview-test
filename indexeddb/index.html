<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>IndexedDB Mobile Test</title>

  <!-- КРИТИЧНО для мобильных -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
    }

    button {
      width: 100%;
      padding: 16px;
      margin-bottom: 12px;
      font-size: 16px;
    }

    pre {
      background: #f5f5f5;
      padding: 12px;
      height: 40vh;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>

  <h2>IndexedDB mobile test</h2>

  <button id="write">WRITE value</button>
  <button id="read">READ value</button>

  <pre id="log"></pre>

  <script>
    const DB_NAME = 'mobile_test_db';
    const DB_VERSION = 1;
    const STORE_NAME = 'kv';

    const logEl = document.getElementById('log');

    function log(msg) {
      logEl.textContent += msg + '\n';
      console.log(msg);
    }

    function openDb() {
      return new Promise((resolve, reject) => {
        try {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onupgradeneeded = (event) => {
            log('onupgradeneeded');
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              db.createObjectStore(STORE_NAME);
            }
          };

          request.onsuccess = () => {
            log('DB opened');
            resolve(request.result);
          };

          request.onerror = () => {
            log('DB open error: ' + request.error);
            reject(request.error);
          };
        } catch (e) {
          log('Exception during open: ' + e);
          reject(e);
        }
      });
    }

    async function writeValue() {
      log('WRITE tapped');
      try {
        const db = await openDb();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);

        store.put('hello mobile indexeddb', 'key');

        tx.oncomplete = () => {
          log('Write success');
          db.close();
        };

        tx.onerror = () => {
          log('Write tx error: ' + tx.error);
        };
      } catch (e) {
        log('Write failed: ' + e);
      }
    }

    async function readValue() {
      log('READ tapped');
      try {
        const db = await openDb();
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);

        const req = store.get('key');

        req.onsuccess = () => {
          log('Read result: ' + req.result);
          db.close();
        };

        req.onerror = () => {
          log('Read req error: ' + req.error);
        };
      } catch (e) {
        log('Read failed: ' + e);
      }
    }

    document.getElementById('write').addEventListener('click', writeValue);
    document.getElementById('read').addEventListener('click', readValue);
  </script>

</body>
</html>
